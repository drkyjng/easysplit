<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HKD Bill Splitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase SDK v9 (modular) via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      setDoc,
      getDoc,
      getDocs,
      deleteDoc,
      query,
      where,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBdeYG1lO3z7I1Vqk3OOmrBkjOdkrZFvGU",
      authDomain: "easysplit-8d59d.firebaseapp.com",
      projectId: "easysplit-8d59d",
      storageBucket: "easysplit-8d59d.firebasestorage.app",
      messagingSenderId: "632617460750",
      appId: "1:632617460750:web:8b87c9c5971d9321cb085f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expose to script.js
    window._firebase = {
      app,
      auth,
      db,
      firebaseAuth: {
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        signOut
      },
      firebaseFirestore: {
        collection,
        doc,
        addDoc,
        setDoc,
        getDoc,
        getDocs,
        deleteDoc,
        query,
        where,
        orderBy,
        serverTimestamp
      }
    };
  </script>

  <script src="script.js" defer></script>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">
        <h1>EasySplit HKD</h1>
        <p>Split multi-currency bills into HKD with custom shares</p>
      </div>

      <div class="user-settings">
        <div class="auth-controls">
          <span id="userStatus" class="muted small">Not signed in</span>
          <button id="googleSignInBtn" class="btn primary-outline small">Sign in with Google</button>
          <button id="signOutBtn" class="btn ghost small" style="display:none;">Sign out</button>
        </div>
        <label class="your-name-label">
          Your name
          <input type="text" id="yourNameInput" placeholder="e.g. Justin" />
        </label>
      </div>
    </header>

    <main class="app-main">
      <!-- Sidebar: projects -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <h2>Projects</h2>
          <button id="addProjectBtn" class="btn primary small">+ New</button>
        </div>
        <ul id="projectsList" class="project-list"></ul>
      </aside>

      <!-- Main content -->
      <section class="content">
        <div id="noProjectMessage" class="card hero" style="display:none;">
          <h2>Welcome to EasySplit</h2>
          <p class="muted">
            Sign in with Google to create your own projects, or open a shared link to view a project in read-only mode.
          </p>
        </div>

        <div id="projectView" style="display:none;">
          <div class="project-header card">
            <div>
              <h2 id="projectName"></h2>
              <p id="projectMeta" class="muted small"></p>
            </div>
              <div class="project-header-actions">
    <button id="shareProjectBtn" class="btn secondary small">Share link</button>
    <button id="editProjectBtn" class="btn primary-outline small">Edit project</button>
    <button id="deleteProjectBtn" class="btn danger small">Delete</button>
  </div>
          </div>

          <!-- Members and balances -->
          <div class="grid-2">
            <div class="card">
              <h3>Members</h3>
              <ul id="membersList" class="pill-list"></ul>
            </div>
            <div class="card">
              <div class="card-header-row">
                <h3>Balances (HKD)</h3>
                <span class="badge" id="editModeBadge">Owner mode</span>
              </div>
              <p class="muted small">
                Positive: they owe this amount. Negative: you owe them.
              </p>
              <table class="table" id="balancesTable">
                <thead>
                  <tr>
                    <th>Member</th>
                    <th>Net balance (HKD)</th>
                    <th>Settled?</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Add expense -->
          <div class="card" id="addExpenseCard">
            <h3>Add expense</h3>
            <form id="addExpenseForm" class="form-grid">
              <label>
                Description
                <input type="text" id="expDescription" required placeholder="Dinner, Taxi, Tickets..." />
              </label>
              <label>
                Date
                <input type="date" id="expDate" required />
              </label>
              <label>
                Payer
                <select id="expPayer" required></select>
              </label>
              <label>
  Currency
  <div class="currency-row">
    <select id="expCurrency" required>
      <option value="HKD" selected>HKD – Hong Kong Dollar</option>
      <option value="USD">USD – US Dollar</option>
      <option value="JPY">JPY – Japanese Yen</option>
      <option value="CNY">CNY – Chinese Yuan</option>
      <option value="OTHER">Other…</option>
    </select>
    <input
      type="text"
      id="expCurrencyOther"
      class="hidden"
      placeholder="e.g. EUR"
      maxlength="3"
      style="text-transform:uppercase;"
    />
  </div>
</label>

<label class="amount-label">
  <span class="amount-label-title">
    Amount (<span id="expAmountCurrencyLabel">HKD</span>)
  </span>
  <input type="number" id="expAmount" required min="0" step="0.01" />
</label>
              <label>
                Rate source
                <select id="expRateSource">
                  <option value="official">Official rate (ECB API)</option>
                  <option value="visa">Visa rate (manual)</option>
                  <option value="mastercard">Mastercard rate (manual)</option>
                  <option value="custom">Custom rate</option>
                </select>
              </label>
              <label>
                Raw FX rate → HKD
                <div class="inline-input">
                  <input type="number" id="expRateRaw" min="0" step="0.000001" placeholder="e.g. 0.056" />
                  <button type="button" id="fetchRateBtn" class="btn secondary small">Fetch official</button>
                </div>
                <span class="help small">
                  Official: fills this automatically. For Visa / Mastercard, use their calculators and enter the rate before fees:
                  <a href="https://usa.visa.com/support/consumer/travel-support/exchange-rate-calculator.html" target="_blank">Visa</a>,
                  <a href="https://www.mastercard.com/global/currencyconversion/" target="_blank">Mastercard</a>.
                </span>
              </label>
              <label>
                Handling fee (%)
                <input type="number" id="expFeePercent" min="0" step="0.01" placeholder="e.g. 1.95" />
                <span class="help small">
                  Applied on top of the raw rate. Effective rate = raw × (1 + fee% / 100).
                </span>
              </label>
              <div class="full-width">
  <p id="hkdTotalPreview" class="small muted">
    HKD total (after FX &amp; fee): —
  </p>
</div>

              <fieldset class="full-width">
                <legend>Who shares this expense?</legend>
                <div id="expParticipants" class="pill-list check-list"></div>
              </fieldset>

              <fieldset class="full-width">
  <legend>Split mode</legend>
  <div class="split-mode-row">
    <label class="radio-pill">
      <input type="radio" name="splitMode" value="equal" checked />
      <span>Equal split</span>
    </label>
    <label class="radio-pill">
      <input type="radio" name="splitMode" value="percent" />
      <span>By percentage (%)</span>
    </label>
    <label class="radio-pill">
      <input type="radio" name="splitMode" value="custom" />
      <span>Custom per person (HKD)</span>
    </label>
  </div>

  <!-- % split -->
  <div id="percentSplitContainer" class="custom-split hidden">
    <table class="table small-table">
      <thead>
        <tr>
          <th>Member</th>
          <th>Share (%)</th>
        </tr>
      </thead>
      <tbody id="percentSplitBody"></tbody>
    </table>
    <p class="small muted" id="percentSplitSummary"></p>
  </div>

  <!-- HKD custom split -->
  <div id="customSplitContainer" class="custom-split hidden">
    <table class="table small-table">
      <thead>
        <tr>
          <th>Member</th>
          <th>Share (HKD)</th>
        </tr>
      </thead>
      <tbody id="customSplitBody"></tbody>
    </table>
    <p class="small muted" id="customSplitSummary"></p>
  </div>
</fieldset>

              <div class="full-width form-actions">
                <button type="submit" class="btn primary">Add expense</button>
              </div>
            </form>
          </div>

          <!-- Expenses list -->
          <div class="card">
            <h3>Expenses</h3>
            <table class="table" id="expensesTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Payer</th>
      <th>Foreign</th>
      <th>Rate source</th>
      <th>Effective rate</th>
      <th>HKD total</th>
      <th>Participants</th>
      <th>Split</th>
      <th>Last updated</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Project modal -->
  <div id="projectModal" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog">
      <h2 id="projectModalTitle">New project</h2>
      <form id="projectForm" class="form-grid">
  <label>
    Project name
    <input type="text" id="projectNameInput" required placeholder="e.g. Osaka Trip 2025" />
  </label>

  <label class="full-width">
    Members (comma-separated)
    <input type="text" id="projectMembersInput" required placeholder="e.g. You, Alice, Bob" />
    <span class="small muted">
      Include yourself (matching the “Your name” field) so splits work correctly.
    </span>
  </label>

  <label class="full-width">
    Editors (Google email, comma-separated, optional)
    <input type="text" id="projectEditorsInput" placeholder="e.g. friend1@gmail.com, friend2@hku.hk" />
    <span class="small muted">
      These Google accounts can add/delete expenses and mark settlements. Only you (owner) can delete the project
      or change this list.
    </span>
  </label>

  <div class="full-width form-actions">
    <button type="button" id="cancelProjectBtn" class="btn secondary">Cancel</button>
    <button type="submit" class="btn primary">Save</button>
  </div>
</form>
    </div>
  </div>
</body>
</html>
